[{"title":"detectron2 源码阅读系列 02 Demo.py","url":"/2020/09/10/20200911-detectron2-02-demo/","content":"\n上一篇通过`demo.py`运行得到了一个检测的结果，这次深入到demo文件里面，分析整体框架的搭建。核心功能就是通过获取运行参数中的输入，进行结果预测，并输出可视化结果。`demo.py`的调用关系如下图所示\n\n![demo结构](http://hexotuchuang.oss-cn-beijing.aliyuncs.com/blog_init/post/detectron2/20200911_demo_frame.png)\n\n###1. demo.py 文件概览\n\n文件主要包含三个函数\n- 主函数\n- `get_parser()`\n- `setup_cfg(args)`\n\n#### 1.1 主函数\n\n总体流程\n***\n1. `mp.set_start_method()`设置多线程操作\n2. `get_parser()` 函数获取参数，存入`args` \n3. `setup_logger()`函数设置日志文件\n4. `logger` 记录参数信息\n5. `setup_cfg(arg)` 将获取的参数进行设置，存入`cfg`\n6. 创建`VisualizationDemo`类的实例为`demo`\n7. 如果输入是图像`(args.input)`\n8. ​    如果输入时单张图片:\n9. ​        确认指定路径下的文件存在\n10. ​    遍历`args.input`:\n11. ​        使用`read_image`读取路径下的图片\n12. ​        记录开始时间\n13. ​        调用`demo.run_on_image`得到预测结果`predictions`和可视化结果`visualized_output`，并记录日志信息（`predictions`预测到多少实例，预测花费时间）\n14. ​        如果需要保存结果`args.output`:\n15. ​            将可视化结果进行保存\n16. ​        否则利用窗口进行展示，按`esc`键退出\n17. 如果输入是网络摄像头`(args.webcam)`:\n18. ​    确认不包含图片输入`args.input`，且没有输出参数`args.output`\n19. ​    设置摄像头为`cam`，并在上面运行`demo.run_on_video`\n20. ​    针对每帧图片的预测结果，窗口显示1ms，按`esc`键退出，退出后释放网络摄像头，关闭所有窗口\n21. 如果输入是视频`(args.video_input)`\n22. ​    将视频读进`video`，获取视频的尺寸信息`width`和`height`, 帧率`frames_per_second`，总帧数`num_frams`，\n23. ​    在`video`上运行`demo.run_on_video`，如果需要输出，则写入`output_file`，否则通过窗口显示结果，按`esc`键退出。运行后释放输入输出视频，关闭所有窗口。\n***\n\n#### 1.2 `get_parser()` 函数\n\n这个函数的核心功能是利用系统的`argparse`模块进行参数解析，主要创建`ArgumentParser`对象，调用`.add_argument()`方法定义参数，使用`.parse_args()`进行参数解析三个步骤。第三个步骤在主函数里面调用，因此这个函数核心代码就只包含对象创建以及添加参数，最后返回`ArgumentParser`对象。\n\n```python\ndef get_parser():\n    parser = argparse.ArgumentParser()\n    parser.add_argument()\n```\n\n这里添加的参数有\n- `--config-file` 配置文件位置\n- `--webcam` 网络摄像头\n- `--video-input` 视频路径\n- `--input` 输入图片路径\n- `--output` 可视化结果输出位置，如果为赋值，则通过窗口显示\n- `--confidence-threshold` 显示实例预测的最小阈值\n- `--opts` 其他可选配置\n\n#### 1.3 `setup_cfg(args)`函数\n\n前面`get_parser()` 函数返回的是一个参数解析器，主函数调用`.parse_args()`进行参数解析后得到`args`是一个`namespace`，指定了对应的配置文件，还需要将配置文件的参数进行解析。\n\n首先构建了一个默认的`CfgNode`对象，主要用来存放基本的网络参数配置，通过调用`.merge_from_file()` 和 `.merge_from_list()`两个方法解析`args`的指定的配置文件，对默认数值进行更新。\n\n### 2. `Predictor.py`文件概览\n\n从上面的总体流程中可以看出，`demo.py`的核心功能是通过`VisualizationDemo` 类实现的，这个类在同目录下的`predictor.py` 文件中。这个文件内部主要包含两个类：\n- `VisualizationDemo`\n\n- `AsyncPredictor`  \n\n\n#### 2.1 `VisualizationDemo` 类\n\n内部定义了以下四个函数：\n- `__init__()`\n- `run_on_image()`\n- `run_on_video()`\n- `_frame_from_video()`\n\n##### 2.1.1 `__init__()`\n定义了预测参数，并根据并行处理需求将`predictor`设置为默认预测器`DefaultPredictor`或者并行预测器`AsyncPredictor`。\n\n##### 2.1.2 `run_on_image(self, image)`\n\n- 输入：图像（H, W, C）图像模式 (BGR)\n- 输出：网络输出结果`predictions`, 可视化结果`vis_output`，可视化结果是`Visualizer`对象。\n\n##### 2.1.3 `_frame_from_video(self, video)`\n获取视频帧\n\n##### 2.1.4 `run_on_video(self, video)`\n调用`_frame_from_video` 方法获取视频帧，对每一帧进行预测，并通过内置的`process_predictions`方法，创建`Visualizer`对象，对结果进行展示。\n\n#### 2.2 `AsyncPredictor`类\n主要是针对多GPU预测进行了处理，每个GPU上构建一个默认预测器`DefaultPredictor`，分别进行预测。\n\n#### 2.3. `DefaultPredictor` 类\n\n不论是单GPU，还是多GPU，最后的预测器都调用了`DefaultPredictor` 类，该类位于`detectron2\\engine\\defaults.py`中，内部只有初始化函数`__init__`和回调函数`__call__`，核心功能是通过给定参数构建端到端的网络，对输入图像进行`Transfrom`后，并送入网络模型，预测结果。\n\ndemo的功能浏览完了，接下去的内容会从`Dataloader`开始，构建模型，评估测试，最终结果可视化。","tags":["源码阅读","深度学习","pytorch"],"categories":["detectron2"]},{"title":"detectron2 源码阅读系列 01 安装流程","url":"/2020/09/10/20200910-detectron2-01-installation/","content":"\n####前言\n[Detectron2](https://github.com/facebookresearch/detectron2) 是Facebook AI Research (FAIR)开源的目标检测框架，在上一代的基础上，基于Pytorch进行了实现。模型涵盖目标检测的Faster R-CNN, RetinaNet, 实例分割的Mask R-CNN, 关键点估计的Dense Pose, 全景分割的Panoptic FPN等多个模型，以及相应数据的加载等。\n\n最近在自己的项目实现过程，深刻意识到设计一个系统与解决一道代码题目是两个不同的概念。正好项目中需要用到Detectron2的部分代码，因此将Detectron2作为自己学习代码规范和项目实现的样例。\n\n###主机环境\n\n| 名称  | 版本  |\n|:-------: | :--------:|\n|操作系统|Linux 16.04|\n|显卡\t|GTX Titan X|\n|驱动\t|418.56\t\t|\n|CUDA|9.0\t\t|\n|Conda|4.84\t\t|\n\n###安装过程\n逐行运行下列命令即可，按照[官方文档](https://detectron2.readthedocs.io/tutorials/install.html)运行的时候，发现少了`opencv-python`库，因此补了一条。\n\n```\nconda create -n detectron2 python=3.6\nconda activate detectron2\nconda install pytorch torchvision cudatoolkit=9.2 -c pytorch\npip install opencv-python\ngit clone https://github.com/facebookresearch/detectron2.git\npython -m pip install -e detectron2\n```\n\n###Demo测试\n####数据准备\n提前找一张图片放进`demo`文件夹中，这里从[网络](http://www.gudaimi.com/Sjfyltu/201812/99590.html)随机照了一张图片，保存的文件名为 `test_pic.jpg`，结果并保存为同目录下的` res_pic.jpg` (`--output` 后的参数)；如果要测试视频，输出参数要将`--input` 改为`--video-input`。其余参数可以使用`python demo.py -h` 进行查看。\n\n####代码运行\n进入`demo`文件夹测试\n\n```\ncd dtectron2/demo\npython demo.py --config-file ../configs/COCO- InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml \\\n--input test_pic.jpg --output res_pic.jpg --opts MODEL.WEIGHTS \\\ndetectron2://COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x/137849600/model_final_f10217.pkl\n```\n\n#####输入\n![输入图像](http://hexotuchuang.oss-cn-beijing.aliyuncs.com/blog_init/post/detectron2/test_pic.jpeg)\n\n#####结果\nzheengti w![测试结果](http://hexotuchuang.oss-cn-beijing.aliyuncs.com/blog_init/post/detectron2/res_pic.jpg)\n\n到这里就完成了Detectron2的全部安装过程了，明天开始阅读demo.py文件z","tags":["源码阅读","深度学习","pytorch"],"categories":["detectron2"]},{"title":"蝉鸣低语","url":"/2020/06/30/gossip_001/","content":"\n## 引子\n\n十七年的蛰伏，只为一个盛夏，只为这个盛夏。\n\n无人的深夜，从地下钻出。这并不是第一次看见这个世界，上一次不过是十七年前，出生后的匆匆一瞥。现在，依旧无暇关注，因为还有更重要的事情等着我。爬上树梢，准备开启生命中的最后一个阶段。在原来的身体里挣扎着，感受着躯壳撕裂开来，一点一点的剥离开来。相同的事情，已经经历了四次，现如今看着褪下的身躯，感叹着这是最后一次了，终于到最后一次了，梦想化作双翼。至此，总算拥有了生命，与灵魂契合的生命。\n\n## 缘起\n\n自己的身份证快要过期了，下一张的有效期便是二十年。大哥自成年之后，即将走上奔三的生涯。终于是到了这个失去的年纪，不论是自己的亲人，抑或是崇拜的偶像，从霍金到张守晟，从金庸到斯坦·李，那些为人类科学事业不断奉献的人，那些伴随着自己成长的角色，终究都成了过往。\n\n自从大学毕业之后，时间过得飞快。不记得哪一天开始，不怎么找歌听了，觉得现在列表里的就不错。也追不上新番了，仿佛中二病，黑子的篮球还是去年的番，夏目友人帐第五季，也不过是刚出的消息。最近买来的游戏，静静的躺在那里，看完了游戏启动画面，就再也没有然后。或许只是出于情怀喜+1吧，半开玩笑的说着“自己花钱买的游戏，凭什么还要花时间玩”，心里却多少有些落寞。遇到事情，不论好坏，也不愿去多谈什么，只是默默放在心底。\n\n回首过去，才发觉忙忙碌碌，却什么都没有做。学了很多，却又什么都没有记住。人生实苦，于我而言，生命本身是没有意义的，更多的是寻找意义的过程，以及这一生中，不论悲喜，给自己留下的感觉。\n\n未来，我如果有一个孩子，我不指望他能达成多大的成就，不求大富大贵，不求功名显赫。但是我想在灿烂星河下讲着牛郎织女的故事，说着奥林匹斯山上众神的纷争，告诉他阿基米德撬动地球的支点，以及梵高笔下的星夜。希望他能够领略浩瀚宇宙中的美景，更希望他能够被那一段段深情的文字所打动，为科学的公式所折服，为艺术的升华所感染。在万家灯火中，体验人间冷暖，学会感恩，懂得体谅。终于，他觉得无愧此生，平静坦然地按自己的计划过完余生。\n\n可是孩子终究是独立的个体，本不应该按照我设定的路线走下去。这个世界，有太多的不如意，带他来到这个世界，或许就已经亏欠他太多了。直到朋友说起，这可能也是你想成为的人吧。那一刻，才意识到，原来这是自己想要成为的样子啊。自己终究不能免俗，将自己未完成的事情，寄希望于自己的孩子，更可笑的是自己还不自知。又或许是自己早早的框定了自己的余生，已经没有去戍守边疆，保家卫国，若是用尽全力，去做一些事情，做成一些事情，就很好了。\n\n关于余生，我总需要一个出口。筹划了很久的博客，总算在今年提上了日程，记下人间的美好，存下自己的呢喃，也为自己的盛夏蛰伏。故此，蝉鸣。","tags":["人间值得"],"categories":["gossip"]}]